#!/bin/bash

SETTINGS="/boot/config/plugins/automover/settings.cfg"
CRON_FILE="/boot/config/plugins/automover/automover.cron"
BOOT_FAIL="/var/tmp/automover_boot_failure"
AUTOMOVER="/usr/local/emhttp/plugins/automover/helpers/automover.sh"

# ðŸ“Œ Clear any previous failure message
rm -f "$BOOT_FAIL"

# ðŸ”Œ Check autostart toggle
AUTOSTART=$(grep autostart "$SETTINGS" | cut -d '"' -f2)
if [[ "$AUTOSTART" != "yes" ]]; then
  echo "Autostart skipped: disabled in settings.cfg" > "$BOOT_FAIL"
  exit 0
fi

# ðŸ•’ Validate interval setting
INTERVAL=$(grep interval "$SETTINGS" | cut -d '"' -f2)
if [[ -z "$INTERVAL" ]]; then
  echo "Autostart failed: No interval set in settings.cfg" > "$BOOT_FAIL"
  exit 1
fi

# ðŸš¦ Wait until Unraid array has started
timeout=120  # max wait time in seconds
elapsed=0

while [[ "$elapsed" -lt "$timeout" ]]; do
  if grep -q 'mdState="STARTED"' /var/local/emhttp/var.ini 2>/dev/null; then
    break
  fi
  sleep 2
  ((elapsed+=2))
done

if [[ "$elapsed" -ge "$timeout" ]]; then
  echo "Autostart failed: Array did not start within $timeout seconds" > "$BOOT_FAIL"
  exit 1
fi

# ðŸ“† Write cron schedule and reload
echo "*/$INTERVAL * * * * $AUTOMOVER &> /dev/null 2>&1" > "$CRON_FILE"
update_cron

# ðŸš€ Optionally run Automover immediately after boot
"$AUTOMOVER" &> /dev/null &
